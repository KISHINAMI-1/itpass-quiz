<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ ã‚¯ã‚¤ã‚º</title>
  <style>
    body { font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 16px; line-height: 1.5; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 900px; margin: 0 auto; }
    .meta { color:#555; font-size: 14px; display:flex; gap:12px; flex-wrap:wrap; }
    .q { font-size: 18px; margin: 12px 0 8px; }
    button { width: 100%; padding: 12px 10px; margin: 6px 0; border-radius: 10px; border: 1px solid #ccc; background: #fff; font-size: 16px; }
    button:active { transform: scale(0.99); }
    .result { margin-top: 10px; font-weight: 700; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .small { width:auto; padding:10px 12px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="meta">
      <div>åˆ†é‡: <span id="field">-</span></div>
      <div>ID: <span id="qid">-</span></div>
      <div>æ­£ç­”æ•°: <span id="ok">0</span>/<span id="total">0</span></div>
    </div>

    <div class="q" id="question">CSVã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div id="choices"></div>

    <div class="result" id="result"></div>

    <div class="row">
      <button class="small" id="nextBtn">æ¬¡ã®å•é¡Œ</button>
      <button class="small" id="reloadBtn">CSVå†èª­ã¿è¾¼ã¿</button>
    </div>
  </div>

<script>
const CSV_PATH = './ITpassport.csv';

let questions = [];
let deck = [];
let deckIndex = 0;

let current = null;
let locked = false;
let correctCount = 0;
let totalCount = 0;

function parseCSV(text) {
  const rows = [];
  let row = [], cell = '', inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i + 1];

    if (c === '"') {
      if (inQuotes && next === '"') { cell += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cell); cell = '';
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && next === '\n') i++;
      row.push(cell); cell = '';
      if (row.some(v => v.trim() !== '')) rows.push(row);
      row = [];
    } else {
      cell += c;
    }
  }
  if (cell.length || row.length) { row.push(cell); rows.push(row); }
  return rows;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function normalizeHeader(h) {
  return (h || '').trim();
}

async function loadQuestions() {
  document.getElementById('question').textContent = 'CSVã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
  document.getElementById('result').textContent = '';

  const res = await fetch(CSV_PATH, { cache: 'no-store' });
  if (!res.ok) throw new Error('CSVã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + res.status);

  const text = await res.text();
  const rows = parseCSV(text);
  if (rows.length < 2) throw new Error('CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

  const header = rows[0].map(normalizeHeader);

  const idx = {
    id: header.indexOf('å•é¡ŒID'),
    field: header.indexOf('åˆ†é‡'),
    q: header.indexOf('å•é¡Œæ–‡'),
    a1: header.indexOf('é¸æŠè‚¢1'),
    a2: header.indexOf('é¸æŠè‚¢2'),
    a3: header.indexOf('é¸æŠè‚¢3'),
    a4: header.indexOf('é¸æŠè‚¢4'),
    ans: header.indexOf('æ­£è§£'),
    exp: header.indexOf('è§£èª¬')
  };

  // å¿…é ˆåˆ—ãƒã‚§ãƒƒã‚¯ï¼ˆè§£èª¬ã¯ä»»æ„ï¼‰
  const required = ['id','field','q','a1','a2','a3','a4','ans'];
  for (const k of required) {
    if (idx[k] === -1) throw new Error(`CSVã®åˆ—åã€Œ${k}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€åã‚’ç¢ºèªï¼‰`);
  }

  questions = rows.slice(1).map(r => ({
    id: (r[idx.id] ?? '').trim(),
    field: (r[idx.field] ?? '').trim(),
    text: (r[idx.q] ?? '').trim(),
    choices: [
      (r[idx.a1] ?? '').trim(),
      (r[idx.a2] ?? '').trim(),
      (r[idx.a3] ?? '').trim(),
      (r[idx.a4] ?? '').trim(),
    ],
    answer: parseInt((r[idx.ans] ?? '').trim(), 10),
    explanation: idx.exp === -1 ? "" : ((r[idx.exp] ?? '').trim())
  })).filter(q =>
    q.text &&
    q.choices.every(c => c) &&
    Number.isInteger(q.answer) &&
    q.answer >= 1 && q.answer <= 4
  );

  if (questions.length === 0) throw new Error('æœ‰åŠ¹ãªå•é¡ŒãŒ0ä»¶ã§ã™ï¼ˆç©ºæ¬„ã‚„æ­£è§£ã®å€¤ã‚’ç¢ºèªï¼‰');

  deck = shuffle([...questions]);
  deckIndex = 0;
  showNextQuestion();
}

function showNextQuestion() {
  locked = false;
  document.getElementById('result').textContent = '';

  // 1å‘¨ã—ãŸã‚‰æ¬¡ã®å‘¨å›ï¼ˆãã®å‘¨å›å†…ã§ã¯é‡è¤‡ãªã—ï¼‰
  if (deckIndex >= deck.length) {
    deck = shuffle([...questions]);
    deckIndex = 0;
    document.getElementById('result').textContent = 'ğŸ”„ 1å‘¨å®Œäº†ï¼æ¬¡ã®å‘¨å›ã«å…¥ã‚Šã¾ã™';
  }

  current = deck[deckIndex++];
  document.getElementById('field').textContent = current.field || '-';
  document.getElementById('qid').textContent = current.id || '-';
  document.getElementById('question').textContent = current.text;

  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';

  current.choices.forEach((c, i) => {
    const btn = document.createElement('button');
    btn.textContent = `${i + 1}. ${c}`;
    btn.onclick = () => judge(i + 1);
    choicesDiv.appendChild(btn);
  });
}

function judge(selected) {
  if (locked) return;
  locked = true;

  totalCount++;
  const ok = (selected === current.answer);
  if (ok) correctCount++;

  document.getElementById('ok').textContent = String(correctCount);
  document.getElementById('total').textContent = String(totalCount);

  const exp = current.explanation ? `ğŸ“˜ è§£èª¬ï¼š${current.explanation}` : 'ğŸ“˜ è§£èª¬ï¼šï¼ˆæœªå…¥åŠ›ï¼‰';

  document.getElementById('result').innerHTML =
    ok
      ? `âœ… æ­£è§£ï¼<br><br>${exp}`
      : `âŒ ä¸æ­£è§£ï¼ˆæ­£è§£ã¯ ${current.answer}ï¼‰<br><br>${exp}`;
}

document.getElementById('nextBtn').addEventListener('click', showNextQuestion);
document.getElementById('reloadBtn').addEventListener('click', () => loadQuestions().catch(e => alert(e.message)));

loadQuestions().catch(e => alert(e.message));
</script>
</body>
</html>